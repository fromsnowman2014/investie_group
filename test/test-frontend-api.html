<!DOCTYPE html>
<html>
<head>
    <title>Frontend API Test - After Hydration Fixes</title>
    <style>
        body { font-family: monospace; background: #1e1e1e; color: #fff; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; }
        .success { background: #1a3d1a; }
        .error { background: #3d1a1a; }
        .warning { background: #3d3d1a; }
        .log { background: #000; padding: 10px; border-radius: 3px; margin: 5px 0; white-space: pre-wrap; }
        .status { font-weight: bold; color: #4CAF50; }
        button { background: #007ACC; color: white; padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a99; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Frontend API Test - Post Hydration Fix</h1>
        <div id="status" class="status">Initializing...</div>
        
        <div class="section">
            <h3>üîß Environment Variables Check</h3>
            <div id="env-check"></div>
        </div>
        
        <div class="section">
            <h3>üåê API Base URL Test</h3>
            <div id="url-test"></div>
            <button onclick="testUrls()">Test URLs</button>
        </div>
        
        <div class="section">
            <h3>üìä Supabase Functions Test</h3>
            <div id="supabase-test"></div>
            <button onclick="testSupabaseFunctions()">Test Stock Data API</button>
        </div>
        
        <div class="section">
            <h3>üìù Console Logs</h3>
            <div id="console-logs" class="log"></div>
        </div>
    </div>

    <script>
        let logs = [];
        
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLog(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            logs.push(`[${timestamp}] ${level}: ${message}`);
            updateConsoleLogs();
            
            // Call original function
            if (level === 'ERROR') originalError(...args);
            else if (level === 'WARN') originalWarn(...args);
            else originalLog(...args);
        }
        
        console.log = (...args) => addLog('LOG', ...args);
        console.error = (...args) => addLog('ERROR', ...args);
        console.warn = (...args) => addLog('WARN', ...args);
        
        function updateConsoleLogs() {
            const element = document.getElementById('console-logs');
            element.textContent = logs.slice(-20).join('\n');
            element.scrollTop = element.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        // Check environment variables
        function checkEnvironment() {
            const envDiv = document.getElementById('env-check');
            
            // Simulate Next.js environment (these would be injected at build time)
            const envVars = {
                'NODE_ENV': 'production',
                'NEXT_PUBLIC_SUPABASE_URL': window.NEXT_PUBLIC_SUPABASE_URL || 'NOT_SET',
                'NEXT_PUBLIC_SUPABASE_ANON_KEY': window.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'NOT_SET',  
                'NEXT_PUBLIC_SUPABASE_FUNCTIONS_URL': window.NEXT_PUBLIC_SUPABASE_FUNCTIONS_URL || 'NOT_SET',
                'NEXT_PUBLIC_API_URL': window.NEXT_PUBLIC_API_URL || 'NOT_SET'
            };
            
            let html = '<div class="log">';
            for (const [key, value] of Object.entries(envVars)) {
                const status = value === 'NOT_SET' ? '‚ùå' : '‚úÖ';
                const displayValue = key.includes('KEY') && value !== 'NOT_SET' 
                    ? `${value.substring(0, 20)}...` 
                    : value;
                html += `${status} ${key}: ${displayValue}\n`;
            }
            html += '</div>';
            envDiv.innerHTML = html;
            
            console.log('Environment variables checked:', envVars);
        }
        
        // Test URL construction
        function testUrls() {
            const urlDiv = document.getElementById('url-test');
            
            const functionsUrl = window.NEXT_PUBLIC_SUPABASE_FUNCTIONS_URL || 
                                 'https://fwnmnjwtbggasmunsfyk.supabase.co/functions/v1';
            const apiUrl = window.NEXT_PUBLIC_API_URL || 
                          'https://investiegroup-production.up.railway.app';
            
            const urls = [
                { name: 'Supabase Functions', url: functionsUrl },
                { name: 'Legacy API', url: apiUrl },
                { name: 'Stock Data Function', url: `${functionsUrl}/stock-data` }
            ];
            
            let html = '<div class="log">';
            urls.forEach(({name, url}) => {
                html += `üîó ${name}: ${url}\n`;
            });
            html += '</div>';
            urlDiv.innerHTML = html;
            
            console.log('URL test completed:', urls);
        }
        
        // Test Supabase Functions
        async function testSupabaseFunctions() {
            const testDiv = document.getElementById('supabase-test');
            updateStatus('Testing Supabase Functions...', 'warning');
            
            const functionsUrl = window.NEXT_PUBLIC_SUPABASE_FUNCTIONS_URL || 
                                 'https://fwnmnjwtbggasmunsfyk.supabase.co/functions/v1';
            const anonKey = window.NEXT_PUBLIC_SUPABASE_ANON_KEY || 
                           'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bm1uand0YmdnYXNtdW5zZnlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjQxMTQ0OTcsImV4cCI6MjAzOTY5MDQ5N30.p5f3VIWgz6b2kKgQ4OydRhqf7oEfWvTiP6KSUmhQBT8';
            
            const testUrl = `${functionsUrl}/stock-data`;
            const testData = { symbol: 'AAPL' };
            
            try {
                console.log('Testing API call to:', testUrl);
                console.log('With headers:', { 'Authorization': `Bearer ${anonKey.substring(0, 20)}...` });
                
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${anonKey}`
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                testDiv.innerHTML = `
                    <div class="log success">
                        ‚úÖ API Call Successful
                        Status: ${response.status}
                        Stock: ${data.symbol || 'N/A'}
                        Price: ${data.currentPrice || data.price || 'N/A'}
                        Response: ${JSON.stringify(data, null, 2)}
                    </div>
                `;
                
                updateStatus('‚úÖ All tests completed successfully!', 'success');
                console.log('API test successful:', data);
                
            } catch (error) {
                testDiv.innerHTML = `
                    <div class="log error">
                        ‚ùå API Call Failed
                        Error: ${error.message}
                    </div>
                `;
                
                updateStatus('‚ùå API test failed', 'error');
                console.error('API test failed:', error);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üîç Running environment checks...', 'info');
            checkEnvironment();
            testUrls();
            updateStatus('‚úÖ Ready for testing', 'success');
            
            // Check for React errors
            window.addEventListener('error', function(e) {
                if (e.message.includes('418') || e.message.includes('Minified React error')) {
                    console.error('üö® REACT ERROR DETECTED:', e.message);
                    updateStatus('üö® React hydration error detected!', 'error');
                }
            });
            
            console.log('üöÄ Test page initialized');
            console.log('üîç Checking for React hydration errors...');
            
            // Auto-test after 2 seconds
            setTimeout(() => {
                console.log('ü§ñ Running automated tests...');
                testSupabaseFunctions();
            }, 2000);
        });
    </script>
</body>
</html>